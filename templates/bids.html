{% extends "base.html" %}

{% block title %}Bid Tracking - Procurement Intel{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-6">
        <h1><i class="bi bi-clipboard-check"></i> Bid Tracking</h1>
        <p class="text-muted">Track your RFP responses and win/loss history</p>
    </div>
    <div class="col-md-6 text-end">
        <a href="{{ url_for('rfps_list') }}" class="btn btn-primary">
            <i class="bi bi-plus"></i> Start New Bid (from RFPs)
        </a>
    </div>
</div>

<!-- Stats Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body text-center">
                <h3>{{ stats.by_status.get('preparing', 0) + stats.by_status.get('considering', 0) }}</h3>
                <p class="mb-0">In Progress</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-info text-white">
            <div class="card-body text-center">
                <h3>{{ stats.by_status.get('submitted', 0) }}</h3>
                <p class="mb-0">Submitted</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body text-center">
                <h3>{{ stats.total_wins }}</h3>
                <p class="mb-0">Won ({{ "%.0f"|format(stats.win_rate) }}%)</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-warning text-dark">
            <div class="card-body text-center">
                <h3>${{ "{:,.0f}".format(stats.total_value_won) }}</h3>
                <p class="mb-0">Total Value Won</p>
            </div>
        </div>
    </div>
</div>

<!-- Filter -->
<div class="card mb-4">
    <div class="card-body">
        <form method="get" class="row g-3 align-items-end">
            <div class="col-md-4">
                <label class="form-label">Status Filter</label>
                <select name="status" class="form-select">
                    <option value="">All Statuses</option>
                    <option value="considering" {{ 'selected' if status_filter == 'considering' }}>Considering</option>
                    <option value="preparing" {{ 'selected' if status_filter == 'preparing' }}>Preparing</option>
                    <option value="submitted" {{ 'selected' if status_filter == 'submitted' }}>Submitted</option>
                    <option value="won" {{ 'selected' if status_filter == 'won' }}>Won</option>
                    <option value="lost" {{ 'selected' if status_filter == 'lost' }}>Lost</option>
                    <option value="no_bid" {{ 'selected' if status_filter == 'no_bid' }}>No Bid</option>
                </select>
            </div>
            <div class="col-md-2">
                <button type="submit" class="btn btn-outline-primary w-100">
                    <i class="bi bi-filter"></i> Filter
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Bids Table -->
<div class="card">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Status</th>
                        <th>RFP Title</th>
                        <th>Agency</th>
                        <th>Due Date</th>
                        <th>Proposal Value</th>
                        <th>Result</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for bid in bids %}
                    <tr>
                        <td>
                            {% if bid.status == 'considering' %}
                            <span class="badge bg-secondary">Considering</span>
                            {% elif bid.status == 'preparing' %}
                            <span class="badge bg-primary">Preparing</span>
                            {% elif bid.status == 'submitted' %}
                            <span class="badge bg-info">Submitted</span>
                            {% elif bid.status == 'won' %}
                            <span class="badge bg-success">Won</span>
                            {% elif bid.status == 'lost' %}
                            <span class="badge bg-danger">Lost</span>
                            {% elif bid.status == 'no_bid' %}
                            <span class="badge bg-dark">No Bid</span>
                            {% endif %}
                        </td>
                        <td>
                            <a href="{{ url_for('bid_detail', bid_id=bid.id) }}">
                                {{ bid.rfp_title[:50] }}{% if bid.rfp_title|length > 50 %}...{% endif %}
                            </a>
                            {% if bid.solicitation_number %}
                            <br><small class="text-muted">{{ bid.solicitation_number }}</small>
                            {% endif %}
                        </td>
                        <td>{{ bid.entity_name or 'Unknown' }}</td>
                        <td>{{ bid.due_date[:10] if bid.due_date else 'TBD' }}</td>
                        <td>
                            {% if bid.proposal_value %}
                            ${{ "{:,.0f}".format(bid.proposal_value) }}
                            {% else %}
                            -
                            {% endif %}
                        </td>
                        <td>
                            {% if bid.status == 'won' %}
                            <span class="text-success"><i class="bi bi-trophy-fill"></i> Won</span>
                            {% elif bid.status == 'lost' %}
                            <span class="text-danger">Lost to {{ bid.winner_name or 'Unknown' }}</span>
                            {% if bid.winning_value %}
                            <br><small class="text-muted">${{ "{:,.0f}".format(bid.winning_value) }}</small>
                            {% endif %}
                            {% else %}
                            -
                            {% endif %}
                        </td>
                        <td>
                            <a href="{{ url_for('bid_detail', bid_id=bid.id) }}" class="btn btn-sm btn-outline-primary">
                                <i class="bi bi-eye"></i>
                            </a>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="7" class="text-center py-5">
                            <i class="bi bi-clipboard-x fs-1 text-muted d-block mb-3"></i>
                            <p class="text-muted">No bid responses yet</p>
                            <a href="{{ url_for('rfps_list') }}" class="btn btn-primary">
                                Browse RFPs to Start Bidding
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}
