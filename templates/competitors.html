{% extends "base.html" %}

{% block title %}Competitor Tracking - Procurement Intel{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-6">
        <h1><i class="bi bi-people"></i> Competitor Tracking</h1>
        <p class="text-muted">Monitor competitor activity and win rates</p>
    </div>
    <div class="col-md-6 text-end">
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addCompetitorModal">
            <i class="bi bi-plus"></i> Add Competitor
        </button>
    </div>
</div>

<!-- Stats Overview -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body text-center">
                <h3>{{ competitors|length }}</h3>
                <p class="mb-0">Tracked Competitors</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-danger text-white">
            <div class="card-body text-center">
                <h3>{{ total_losses }}</h3>
                <p class="mb-0">Bids Lost to Competitors</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-warning text-dark">
            <div class="card-body text-center">
                <h3>{{ top_competitor.name[:15] if top_competitor else 'N/A' }}{% if top_competitor and top_competitor.name|length > 15 %}...{% endif %}</h3>
                <p class="mb-0">Top Competitor</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-info text-white">
            <div class="card-body text-center">
                <h3>${{ "{:,.0f}".format(total_value_lost) }}</h3>
                <p class="mb-0">Value Lost to Competitors</p>
            </div>
        </div>
    </div>
</div>

<!-- Competitors Table -->
<div class="card">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Competitor</th>
                        <th>Contact</th>
                        <th>Wins Against Us</th>
                        <th>Total Value Won</th>
                        <th>Strengths</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for competitor in competitors %}
                    <tr>
                        <td>
                            <strong>{{ competitor.name }}</strong>
                            {% if competitor.website %}
                            <br><a href="{{ competitor.website }}" target="_blank" class="small">
                                <i class="bi bi-globe"></i> Website
                            </a>
                            {% endif %}
                        </td>
                        <td>
                            {% if competitor.contact_name %}
                            {{ competitor.contact_name }}<br>
                            {% endif %}
                            {% if competitor.contact_email %}
                            <small class="text-muted">{{ competitor.contact_email }}</small>
                            {% endif %}
                        </td>
                        <td>
                            <span class="badge bg-danger">{{ competitor.win_count or 0 }}</span>
                        </td>
                        <td>
                            {% if competitor.total_value_won %}
                            ${{ "{:,.0f}".format(competitor.total_value_won) }}
                            {% else %}
                            -
                            {% endif %}
                        </td>
                        <td>
                            <small>{{ competitor.strengths[:50] if competitor.strengths else '-' }}{% if competitor.strengths and competitor.strengths|length > 50 %}...{% endif %}</small>
                        </td>
                        <td>
                            <a href="{{ url_for('competitor_detail', competitor_id=competitor.id) }}" class="btn btn-sm btn-outline-primary">
                                <i class="bi bi-eye"></i>
                            </a>
                            <button class="btn btn-sm btn-outline-danger"
                                    onclick="deleteCompetitor({{ competitor.id }}, '{{ competitor.name }}')">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="6" class="text-center py-5">
                            <i class="bi bi-people fs-1 text-muted d-block mb-3"></i>
                            <p class="text-muted">No competitors tracked yet</p>
                            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addCompetitorModal">
                                <i class="bi bi-plus"></i> Add Your First Competitor
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Add Competitor Modal -->
<div class="modal fade" id="addCompetitorModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form action="{{ url_for('competitor_create') }}" method="post">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-person-plus"></i> Add Competitor</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Company Name <span class="text-danger">*</span></label>
                        <input type="text" name="name" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Website</label>
                        <input type="url" name="website" class="form-control" placeholder="https://...">
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Contact Name</label>
                            <input type="text" name="contact_name" class="form-control">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Contact Email</label>
                            <input type="email" name="contact_email" class="form-control">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Known Strengths</label>
                        <textarea name="strengths" class="form-control" rows="2"
                                  placeholder="What are they good at?"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Known Weaknesses</label>
                        <textarea name="weaknesses" class="form-control" rows="2"
                                  placeholder="Where do they struggle?"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Notes</label>
                        <textarea name="notes" class="form-control" rows="2"
                                  placeholder="Any other intel..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-plus"></i> Add Competitor
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Form (hidden) -->
<form id="deleteForm" method="post" style="display: none;">
</form>
{% endblock %}

{% block extra_js %}
<script>
function deleteCompetitor(id, name) {
    if (confirm('Are you sure you want to delete "' + name + '"?')) {
        const form = document.getElementById('deleteForm');
        form.action = '/competitors/' + id + '/delete';
        form.submit();
    }
}
</script>
{% endblock %}
